---
title: "College Rankings and Pay"
date: '2021-04-11T21:13:14-05:00'
summary: College rankings are a standard input for most students when choosing a school.
  But to what extent does a college's rank relate to how much a graduate makes 10
  years into their career? We'll answer this question by web scraping data from a
  variety of online sources with R and Python, and then build a model to understand
  which factors matter most to post-college pay.
tags:
- College Rankings
- Career
- R
- Python
categories:
- College Rankings
- Career
- R
- Python
---



<p><img src="/post/2021-04-11-college-rankings-salary/images/belushi.jpg" width="700" height="400" /></p>
<div id="overview" class="section level3">
<h3>Overview</h3>
<p>Rankings are a pervasive part of modern life, especially for big decisions ‚Äì like shelling out thousands of dollars for an education. Indeed, college rankings are among the most widely cited rankings in existence. So naturally, students, parents, and college administrators fret about where their school lands along these highly debated spectrums. But does it matter in terms of future earnings potential? While education is more than a simple ‚Äúmeans to an end,‚Äù making a decent living is amongst the reasons why students pull all-nighters, work terrible summer jobs, and do everything they can to position themselves for a lucrative, meaningful career. Accordingly, this post will focus on the following topics:</p>
<p>ü§ì Understanding the relationship between mid-career pay and college ranking after accounting for external variables (e.g., % of STEM degrees conferred each year).</p>
<p>ü§ì Understanding the relative contribution of all variables to mid-career pay.</p>
<p>Since I‚Äôm a big fan of Learning-by-doing, I‚Äôve included all code used to answer these questions. If you are simply interested in the answers <a href="#analysis">click here</a>.</p>
</div>
<div id="data-collection" class="section level3">
<h3>Data Collection</h3>
<p>Let‚Äôs start off by defining our data sources, which include:</p>
<ul>
<li><p>Mid-career pay by college from <a href="www.payscale.com">payscale.com</a>.</p></li>
<li><p>Undergraduate college rankings from <a href="https://www.forbes.com/top-colleges/#551bb5519877">forbes</a></p></li>
<li><p>Cost of living index by state from <a href="https://meric.mo.gov/data/cost-living-data-series">here</a></p></li>
</ul>
<p>The data is stored across various websites, so we‚Äôll need to first scrape and format it prior to doing any analysis. All source code for the data-collections functions is in the <a href="#appendix">appendix</a>. Each can be executed by using the <code>reticulate</code> package. However, if you want to follow along with analysis and avoid all of the web-scraping (my recommendation), you can pull the data directly into R from Github.</p>
<pre class="r"><code># Core package
library(tidyverse)
library(janitor)

# Calling python functions from R
library(reticulate)

# For joins
library(fuzzyjoin)

# Modeling packages
library(broom)
library(recipes)
library(rsample)
library(tidymodels)
library(tidytext)

# Explainable ML
library(DALEX)
library(DALEXtra)

# --- Uncomment to scrape the original data
# specify which version of Python to use
# reticulate::use_python(&#39;//anaconda/bin/python&#39;, required = TRUE)
# reticulate::source_python(&#39;college_cost_of_living_data.py&#39;)
# reticulate::source_python(&#39;collect_payscale_data.py&#39;)
# reticulate::source_python(&#39;collect_college_ranks.py&#39;)
# col_df &lt;- collect_col_data()
# pay_df &lt;- collect_payscale_data()
# ranks_df &lt;- collect_college_ranks_data()

# --- Download from Github
url &lt;- &quot;https://raw.githubusercontent.com/thecodeforest/codeforest_datasets/main&quot;
post_location &lt;- &quot;college_rankings_salary_data&quot;
full_path &lt;- file.path(url, post_location)
col_df &lt;- read_csv(file.path(full_path, &#39;cost_of_living.csv&#39;)) %&gt;% clean_names()
pay_df &lt;- read_csv(file.path(full_path, &#39;college_pay.csv&#39;)) %&gt;% clean_names()
ranks_df &lt;- read_csv(file.path(full_path, &#39;college_ranks.csv&#39;)) %&gt;% clean_names()</code></pre>
<p>We‚Äôll start by doing some cleaning and exploratory data analysis (EDA) after loading our data.</p>
<pre class="r"><code>pay_df_clean &lt;- pay_df %&gt;% 
  clean_names() %&gt;% 
  rename(college_name = name,
         pay_rank = rank
  ) %&gt;% 
  select(college_name, type, state, pay_rank, early_pay, mid_pay, pct_stem) %&gt;% 
  mutate(college_name = str_to_lower(college_name),
         college_name = str_replace_all(college_name, &quot;_&quot;, &quot; &quot;),
         pct_stem = parse_number(pct_stem),
         early_pay = parse_number(early_pay),
         mid_pay = parse_number(mid_pay)
  )</code></pre>
<p>Let‚Äôs peak at the first few rows of the compensation data.</p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#rtovdsquel .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#rtovdsquel .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rtovdsquel .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#rtovdsquel .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#rtovdsquel .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rtovdsquel .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#rtovdsquel .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#rtovdsquel .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#rtovdsquel .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#rtovdsquel .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#rtovdsquel .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#rtovdsquel .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#rtovdsquel .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#rtovdsquel .gt_from_md > :first-child {
  margin-top: 0;
}

#rtovdsquel .gt_from_md > :last-child {
  margin-bottom: 0;
}

#rtovdsquel .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#rtovdsquel .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#rtovdsquel .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtovdsquel .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#rtovdsquel .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#rtovdsquel .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#rtovdsquel .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#rtovdsquel .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#rtovdsquel .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rtovdsquel .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#rtovdsquel .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#rtovdsquel .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#rtovdsquel .gt_left {
  text-align: left;
}

#rtovdsquel .gt_center {
  text-align: center;
}

#rtovdsquel .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#rtovdsquel .gt_font_normal {
  font-weight: normal;
}

#rtovdsquel .gt_font_bold {
  font-weight: bold;
}

#rtovdsquel .gt_font_italic {
  font-style: italic;
}

#rtovdsquel .gt_super {
  font-size: 65%;
}

#rtovdsquel .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="rtovdsquel" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style><strong>Sample Compensentation Data</strong></th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">college_name</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">type</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">state</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">pay_rank</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">early_pay</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">mid_pay</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">pct_stem</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">harvey mudd college</td>
      <td class="gt_row gt_center">Engineering, Liberal Arts School, Private School</td>
      <td class="gt_row gt_center">California</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">91400</td>
      <td class="gt_row gt_center">162500</td>
      <td class="gt_row gt_center">85</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">massachusetts institute of technology (mit)</td>
      <td class="gt_row gt_center">Engineering, Private School, Research University</td>
      <td class="gt_row gt_center">Massachusetts</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">88300</td>
      <td class="gt_row gt_center">158100</td>
      <td class="gt_row gt_center">69</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">united states naval academy (usna) at annapolis</td>
      <td class="gt_row gt_center">Engineering, Liberal Arts School, Sober School, For Sports Fans, State School</td>
      <td class="gt_row gt_center">Maryland</td>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_center">79600</td>
      <td class="gt_row gt_center">152600</td>
      <td class="gt_row gt_center">58</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">princeton university</td>
      <td class="gt_row gt_center">Ivy League, Private School, Research University, For Sports Fans</td>
      <td class="gt_row gt_center">New Jersey</td>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_center">77300</td>
      <td class="gt_row gt_center">150500</td>
      <td class="gt_row gt_center">48</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">california institute of technology (caltech)</td>
      <td class="gt_row gt_center">Engineering, Private School, Research University</td>
      <td class="gt_row gt_center">California</td>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_center">87600</td>
      <td class="gt_row gt_center">150300</td>
      <td class="gt_row gt_center">97</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>We‚Äôll merge the cost of living (COL) and college rankings data in the next two steps. Let‚Äôs start with COL by state to adjust for its effect on pay. The rationale for adding this variable is that many college graduates end up working in the same city or state as their college. For example, if you go to Ohio State, there‚Äôs a good chance you‚Äôll take a job in Ohio. Likewise, if you attend New York University, you‚Äôll probably end up somewhere in New York. Therefore, the cost of living in Ohio is different from New York, and employers take this into account when setting salaries. However, these cost differences are not related to the rank of one‚Äôs college, so to get a better idea of the relationship between college rank and mid-career pay, we‚Äôll want to ‚Äúadjust‚Äù for these variables.</p>
<pre class="r"><code>pay_df_clean &lt;- inner_join(pay_df_clean, col_df, on=&#39;state&#39;)</code></pre>
<p>The next step is a bit trickier. We‚Äôll be joining on (gasp!) the college‚Äôs name to bring together compensation and college rankings. Anyone who has spent a few minutes working with data knows it‚Äôs generally a bad idea to join on strings, especially when those strings come from unrelated data sources. Indeed, I came across this tweet the other day, and I feel seen.</p>
<p><img src="/post/2021-04-11-college-rankings-salary/images/philadelphia.png" width="400" height="200" /><br />
However, as data scientists, we rarely have the dataset we want, so we‚Äôll have to employ the magic you see below to create a consistent mapping between college names (Yes, regular expressions have always felt magical to me).</p>
<pre class="r"><code>pay_df_clean &lt;- pay_df_clean %&gt;% 
  mutate(college_name = str_replace_all(college_name, &quot; \\(.+?\\)&quot;, &quot;&quot;),
        college_name = str_replace_all(college_name, &#39;%2c&#39;, &#39;,&#39;),
        college_name = str_replace_all(college_name, &#39;%26&#39;, &#39;&amp;&#39;),
        college_name = str_replace_all(college_name, &#39;%27&#39;, &quot;&#39;&quot;),
        college_name = str_replace_all(college_name, &#39;at (.+/?)&#39;, &#39;&#39;), 
        college_name = str_replace_all(college_name, &#39;,\\s[a-z][a-z]&#39;, &#39;&#39;), # state at end
        college_name = str_replace_all(college_name, &#39; - &#39;, &#39;-&#39;),
        college_name = str_trim(college_name)
        )</code></pre>
<p>We‚Äôll also do some light cleaning for the college ranks data.</p>
<pre class="r"><code>ranks_df_clean &lt;- ranks_df %&gt;% 
  rename(college_name = friendly_name,
         college_rank = rank
         ) %&gt;% 
  mutate(college_name = tolower(college_name)) %&gt;% 
  na.omit()</code></pre>
<p>In the next step, we‚Äôll bring the compensation and college rankings together via a ‚Äúfuzzy join.‚Äù This type of join is useful when the key (or field(s) you join is ‚Äúclose enough‚Äù but not an exact match. The <code>max_dist</code> parameter below is how we define ‚Äúclose enough.‚Äù The lower the number for this parameter, the closer two strings will need to be in their structure to match.</p>
<pre class="r"><code>analysis_df &lt;- stringdist_inner_join(pay_df_clean, 
                                     ranks_df_clean,
                                     by=&#39;college_name&#39;,
                                     max_dist=2
                                     )
n_row_reduced &lt;- round((nrow(pay_df_clean) - nrow(analysis_df)) / nrow(pay_df_clean) * 100, 2)
print(glue::glue(&#39;Pct excluded: {n_row_reduced}%&#39;))</code></pre>
<pre><code>## Pct excluded: 29.82%</code></pre>
<p>A good practice after executing an inner-join is to determine if the number of records has changed. The number of records are reduced by 29.82% following our join. If I were compensated for this analysis, I would return to the regular expressions above to see where I could further improve the match rate. However, we‚Äôll trudge along with our smaller dataset to keep things moving along.</p>
<p>The other thing to keep in mind with fuzzy joins is that duplicate matches can occur, which the example below illustrates:</p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#sjzrypbqnw .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#sjzrypbqnw .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sjzrypbqnw .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#sjzrypbqnw .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#sjzrypbqnw .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sjzrypbqnw .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#sjzrypbqnw .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#sjzrypbqnw .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#sjzrypbqnw .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#sjzrypbqnw .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#sjzrypbqnw .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#sjzrypbqnw .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#sjzrypbqnw .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#sjzrypbqnw .gt_from_md > :first-child {
  margin-top: 0;
}

#sjzrypbqnw .gt_from_md > :last-child {
  margin-bottom: 0;
}

#sjzrypbqnw .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#sjzrypbqnw .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#sjzrypbqnw .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjzrypbqnw .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#sjzrypbqnw .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#sjzrypbqnw .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#sjzrypbqnw .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#sjzrypbqnw .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#sjzrypbqnw .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sjzrypbqnw .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#sjzrypbqnw .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#sjzrypbqnw .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#sjzrypbqnw .gt_left {
  text-align: left;
}

#sjzrypbqnw .gt_center {
  text-align: center;
}

#sjzrypbqnw .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#sjzrypbqnw .gt_font_normal {
  font-weight: normal;
}

#sjzrypbqnw .gt_font_bold {
  font-weight: bold;
}

#sjzrypbqnw .gt_font_italic {
  font-style: italic;
}

#sjzrypbqnw .gt_super {
  font-size: 65%;
}

#sjzrypbqnw .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="sjzrypbqnw" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="3" class="gt_heading gt_title gt_font_normal" style><strong>Names with Multiple Matches</strong></th>
    </tr>
    <tr>
      <th colspan="3" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">college_name.x</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">college_name.y</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">n_match</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">stanford university</td>
      <td class="gt_row gt_center">stanford university</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">stanford university</td>
      <td class="gt_row gt_center">samford university</td>
      <td class="gt_row gt_center">2</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">brown university</td>
      <td class="gt_row gt_center">brown university</td>
      <td class="gt_row gt_center">1</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">brown university</td>
      <td class="gt_row gt_center">rowan university</td>
      <td class="gt_row gt_center">2</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>The duplicate issue can be addressed by taking the closest match. Fortunately, our observations are ordered in terms of similarity, so we can take the first match and exclude matches with a rank other than 1.</p>
<pre class="r"><code>analysis_df &lt;- analysis_df %&gt;% 
  filter(n_match == 1) %&gt;% 
  select(-n_match, college_name.y) %&gt;% 
  rename(college_name = college_name.x) %&gt;% 
  na.omit() </code></pre>
<p>We are now ready to move on to some basic analysis.</p>
</div>
<div id="analysis" class="section level3">
<h3>Analysis</h3>
<p>Let‚Äôs start by examining the relationship between our two main variables of interest: college rank and mid-career pay.</p>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-11-1.png" width="960" /></p>
<p>Earnings drop quicker for highly ranked colleges relative to lower ranked colleges. Let‚Äôs break this out by bucketing the ranks and examining the slopes for each bucket ‚Äì that is, the expected change in salary as the ranking decreases by one.</p>
<pre class="r"><code>analysis_df = analysis_df %&gt;% 
  mutate(rank_bucket = case_when(college_rank &gt;= 1 &amp; college_rank &lt;= 50 ~ &#39;1 - 50&#39;,
                                 college_rank &gt;= 51 &amp; college_rank &lt;= 100 ~ &#39;51 - 100&#39;,
                                 college_rank &gt; 100 &amp; college_rank &lt;= 200 ~ &#39;101 - 200&#39;,
                                 college_rank &gt; 200 &amp; college_rank &lt;= 300 ~ &#39;201 - 300&#39;,
                                 college_rank &gt; 300 &amp; college_rank &lt;= 400 ~ &#39;301 - 400&#39;,
                                 college_rank &gt; 400 ~ &#39;&gt; 400&#39;
  )
  )</code></pre>
<p>Let‚Äôs visualize the slopes for each bucket.</p>
<pre class="r"><code>rank_bucket_est = analysis_df %&gt;% 
  group_by(rank_bucket) %&gt;% 
  do(tidy(lm(mid_pay ~ college_rank, data=.))) %&gt;% 
  select(rank_bucket, term, estimate) %&gt;% 
  ungroup() %&gt;% 
  reshape::cast(rank_bucket ~ term, value = &#39;estimate&#39;) %&gt;% 
  clean_names() %&gt;% 
  rename(rank_coeff = college_rank)

rank_bucket_est &lt;- rank_bucket_est %&gt;% 
  inner_join(analysis_df, by = &#39;rank_bucket&#39;) %&gt;% 
  mutate(predicted_income = college_rank * rank_coeff + intercept) %&gt;% 
  mutate(rank_bucket = factor(rank_bucket,
                              levels = c(&#39;1 - 50&#39;,
                                         &#39;51 - 100&#39;,
                                         &#39;101 - 200&#39;,
                                         &#39;201 - 300&#39;,
                                         &#39;301 - 400&#39;,
                                         &#39;&gt; 400&#39;
                              )
  ))</code></pre>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-14-1.png" width="960" /></p>
<p>While the relationship between earnings and rank is non-linear, this provides a rough estimate of what we initially noticed in the first scatterplot. For example, colleges in the 1- 50 bucket experienced a pay decrease of ~$520 for each one-unit reduction in rank. In contrast, for colleges in the &gt; 400 bucket, a one-unit reduction in position results only in a ~$34 drop in compensation.</p>
<p>At this point, we‚Äôve established that (1) rank is a decent predictor of earnings, and (2) the nature of this relationship varies by the level of the rank, indicating that a modeling approach that handles non-linearity would likely perform better than our current linear model. Accordingly, we‚Äôll use a tree-based algorithm to capture these non-linearities and any interactions between college rank and our other variables.</p>
</div>
<div id="feature-engineering-modeling" class="section level3">
<h3>Feature Engineering &amp; Modeling</h3>
<p>We‚Äôll start by defining how we‚Äôll evaluate our model‚Äôs performance. For regression problems, I like to begin with mean-absolute-error (MAE) as an evaluation metric for one reason: it expresses how large of an error I can expect in the original units of my outcome variable. Framing our model‚Äôs performance in this way makes it easier to interpret and explain when it comes down to evaluating how much faith I should put in the outputs.</p>
<pre class="r"><code># define key metric that we want to evaluate against
mset &lt;- metric_set(mae)

# specify x variables
x_vars = c(&#39;pct_stem&#39;, &#39;type&#39; ,&#39;cost_of_living&#39;, &#39;college_rank&#39;)
y_var = &#39;mid_pay&#39;
id_vars = &#39;college_name&#39;
model_df &lt;- analysis_df %&gt;% select(c(id_vars, x_vars, y_var))</code></pre>
<p>We‚Äôll also do some minimal feature engineering on the <code>type</code> field, which classifies colleges as being one of the following types:</p>
<pre class="r"><code>college_types &lt;- model_df %&gt;% 
  separate_rows(type, sep = &quot;, &quot;) %&gt;% 
  count(type, sort = TRUE) </code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#khwmayfjhy .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#khwmayfjhy .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#khwmayfjhy .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#khwmayfjhy .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#khwmayfjhy .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#khwmayfjhy .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#khwmayfjhy .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#khwmayfjhy .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#khwmayfjhy .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#khwmayfjhy .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#khwmayfjhy .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#khwmayfjhy .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#khwmayfjhy .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#khwmayfjhy .gt_from_md > :first-child {
  margin-top: 0;
}

#khwmayfjhy .gt_from_md > :last-child {
  margin-bottom: 0;
}

#khwmayfjhy .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#khwmayfjhy .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#khwmayfjhy .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#khwmayfjhy .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#khwmayfjhy .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#khwmayfjhy .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#khwmayfjhy .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#khwmayfjhy .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#khwmayfjhy .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#khwmayfjhy .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#khwmayfjhy .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#khwmayfjhy .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#khwmayfjhy .gt_left {
  text-align: left;
}

#khwmayfjhy .gt_center {
  text-align: center;
}

#khwmayfjhy .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#khwmayfjhy .gt_font_normal {
  font-weight: normal;
}

#khwmayfjhy .gt_font_bold {
  font-weight: bold;
}

#khwmayfjhy .gt_font_italic {
  font-style: italic;
}

#khwmayfjhy .gt_super {
  font-size: 65%;
}

#khwmayfjhy .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="khwmayfjhy" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="2" class="gt_heading gt_title gt_font_normal" style><strong>College Types</strong></th>
    </tr>
    <tr>
      <th colspan="2" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">type</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">n</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">Private School</td>
      <td class="gt_row gt_center">203</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">For Sports Fans</td>
      <td class="gt_row gt_center">145</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Research University</td>
      <td class="gt_row gt_center">136</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">State School</td>
      <td class="gt_row gt_center">100</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Liberal Arts School</td>
      <td class="gt_row gt_center">87</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Religious</td>
      <td class="gt_row gt_center">75</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Engineering</td>
      <td class="gt_row gt_center">26</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Party School</td>
      <td class="gt_row gt_center">14</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Ivy League</td>
      <td class="gt_row gt_center">8</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Sober School</td>
      <td class="gt_row gt_center">8</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Business</td>
      <td class="gt_row gt_center">6</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Art</td>
      <td class="gt_row gt_center">2</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Some types of colleges may lead graduates into higher or lower-paying fields. First, however, we‚Äôll have to translate these into a format that can feed into a machine learning model.</p>
<pre class="r"><code>college_type_feature &lt;- model_df %&gt;% 
  select(college_name, type) %&gt;%
  separate_rows(type, sep = &quot;, &quot;) %&gt;%
  recipe(.) %&gt;%
  update_role(college_name, new_role = &#39;id variable&#39;) %&gt;%
  step_dummy(type, one_hot=TRUE) %&gt;%
  step_nzv(all_predictors()) %&gt;%
  prep() %&gt;%
  juice() %&gt;%
  group_by(college_name) %&gt;%
  summarise_at(vars(starts_with(&#39;type_&#39;)), sum) %&gt;%
  clean_names()

names(college_type_feature) &lt;- str_replace(names(college_type_feature), &#39;type_&#39;, &#39;&#39;)
college_type_vars = setdiff(names(college_type_feature), &#39;college_name&#39;)</code></pre>
<p>Next, we‚Äôll join the features back into our dataset and transition to building our model.</p>
<pre class="r"><code>model_df &lt;- model_df %&gt;%
  inner_join(college_type_feature, on = &#39;college_name&#39;) %&gt;%
  select(-type, -liberal_arts_school) %&gt;%
  relocate(y_var, .after = last_col())</code></pre>
<pre><code>## Joining, by = &quot;college_name&quot;</code></pre>
<p>We‚Äôll start by splitting our data into training and testing. The train is used for tuning (or which combination of hyperparameters yields the lowest MAE). We‚Äôll then test our final model on the holdout set to get a feel for overall performance.</p>
<pre class="r"><code>set.seed(2021)
spl &lt;- initial_split(model_df)
train &lt;- training(spl)
test &lt;- testing(spl)
train_folds &lt;- vfold_cv(train, v = 5, strata = y_var)</code></pre>
<p>Let‚Äôs specify our ‚Äúrecipe‚Äù below, which is the series of data-preparation steps executed before fitting our model.</p>
<pre class="r"><code>rank_recipe &lt;- 
  model_df %&gt;% 
  recipe(mid_pay ~ ., data = train) %&gt;% 
  update_role(college_name, new_role = &#39;id variable&#39;)</code></pre>
<p>Then, we‚Äôll create a tuning grid for our XGBoost model.</p>
<pre class="r"><code>grid_control &lt;- control_grid(save_pred= TRUE,
                             save_workflow = TRUE,
                             extract = extract_model
                             )
xg_spec &lt;- boost_tree(mode=&#39;regression&#39;,
                      mtry = tune(),
                      trees = tune(),
                      learn_rate = .01
                      ) %&gt;% 
           set_engine(&quot;xgboost&quot;)</code></pre>
<p>Once tuning is complete and the algorithm has been specified, we‚Äôll combine our steps into a <code>workflow</code>, which holds the fitting and predicting operations in a single object.</p>
<pre class="r"><code>xg_workflow &lt;- workflow() %&gt;% 
  add_recipe(rank_recipe) %&gt;% 
  add_model(xg_spec)</code></pre>
<p>Finally, we‚Äôll pull in our split training data and evaluate performance across the different combinations of our hyperparameters. Note that we are not tuning the learning rate in an effort to minimize the number of combinations to test.</p>
<pre class="r"><code>set.seed(123)
xg_tuned &lt;- xg_workflow %&gt;% 
  tune_grid(train_folds,
            metrics = mset,
            grid = crossing(mtry = c(2, 4, 6, 8),
                            trees = seq(50, 1000, 50)
                            ),

            )</code></pre>
<p>The plot below indicates the performance across each of the combinations</p>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-25-1.png" width="960" /></p>
<pre class="r"><code>xg_tuned %&gt;% 
collect_metrics() %&gt;% 
arrange(mean) %&gt;% 
head(5)</code></pre>
<pre><code>## # A tibble: 5 x 8
##    mtry trees .metric .estimator  mean     n std_err .config
##   &lt;dbl&gt; &lt;dbl&gt; &lt;chr&gt;   &lt;chr&gt;      &lt;dbl&gt; &lt;int&gt;   &lt;dbl&gt; &lt;chr&gt;  
## 1     6   500 mae     standard   6328.     5    236. Model50
## 2     6   550 mae     standard   6329.     5    259. Model51
## 3     6   600 mae     standard   6331.     5    287. Model52
## 4     6   650 mae     standard   6350.     5    325. Model53
## 5     6   700 mae     standard   6361.     5    352. Model54</code></pre>
<p>Based on these results, it looks like ~600 trees and six parameters yield the best results. Next, we‚Äôll extract the best model, fit it to the complete training set, and see how well it performs on our test set.</p>
<pre class="r"><code>xg_fit &lt;- xg_workflow %&gt;% 
  finalize_workflow(select_best(xg_tuned)) %&gt;% 
  fit(train)

bind_cols(test, xg_fit %&gt;% predict(test)) %&gt;% 
  mae(mid_pay, .pred)</code></pre>
<pre><code>## # A tibble: 1 x 3
##   .metric .estimator .estimate
##   &lt;chr&gt;   &lt;chr&gt;          &lt;dbl&gt;
## 1 mae     standard       7411.</code></pre>
<p>While the MAE is higher here, it‚Äôs not too different from what we observed above, indicating that we aren‚Äôt overfitting with the hyperparameters we‚Äôve selected. Now that we know how well the model performs on our holdout-set let‚Äôs examine which variables are the most important.</p>
<pre class="r"><code>var_imp &lt;- xgboost::xgb.importance(model = xg_fit$fit$fit$fit)

var_imp %&gt;% 
  clean_names() %&gt;% 
  mutate(feature = str_replace_all(feature, &#39;_&#39;, &#39; &#39;),
         feature = str_to_title(feature),
         feature = fct_reorder(feature, gain),) %&gt;% 
  ggplot(aes(feature, gain)) + 
  geom_col(color = &#39;black&#39;) + 
  coord_flip() + 
  theme_bw() + 
  my_plot_theme() + 
  labs(x=NULL,
       y=&#39;Feature Importance&#39;
       )</code></pre>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-28-1.png" width="960" /></p>
<p>The variable importance ratings are unsurprising. College rank is the most important variable, followed by the percentage of students majoring in Science, Technology, Engineering, or Math (STEM) major, with Cost of Living possessing some additional explanatory power. The college-type variables appear somewhat less critical.</p>
</div>
<div id="interpreting-model-predictions" class="section level3">
<h3>Interpreting Model Predictions</h3>
<p>So far, we‚Äôve established that college rank, cost of living, and college major (or the percentage of STEM students) are associated with variation in mid-career pay. However, to make this actionable, it helps to tailor these predictions to an individual‚Äôs circumstances. For example, let‚Äôs say we want a general idea of how much our mid-career salary varies between a subset of colleges. We can use a technique called ‚Äúlocal model interpretation,‚Äù which can provide answers to the following questions:</p>
<ul>
<li>Why did our model predict $120,000?</li>
<li>What effect does college‚Äôs state or specific rank have on predicted mid-career earnings?</li>
</ul>
<p>The great thing about these techniques is that they open the ‚Äúblack box‚Äù of more intricate machine learning models rather than simply telling us which variables are more important than others. Below we‚Äôll set up our ‚Äúexplainer‚Äù and test our previously trained model on specific observations.</p>
<pre class="r"><code>x_values = train[setdiff(names(train), y_var)]
y_values = train[y_var]

pred &lt;- function(model, newdata){
  results &lt;- model %&gt;% predict(newdata) %&gt;% pull(.pred)
  return(results)

}

explainer_xg &lt;- DALEX::explain(model=xg_fit,
                              data = x_values,
                              y = y_values,
                              predict_function = pred,
                              label = &#39;xg explainer&#39;,
                              verbose = FALSE
                        )</code></pre>
<p>Let‚Äôs test it out on my graduate college - Northwestern University (go Cats!). If you were an undergraduate attending Northwestern and plan to work within the state of Illinois, how much can you expect to make, and what factors are associated with an increase/decrease in potential mid-career earnings?</p>
<pre class="r"><code>nu_student &lt;- model_df %&gt;% filter(college_name == &#39;northwestern university&#39;)
nu_student_pred &lt;- DALEX::predict_parts_break_down(explainer_xg, nu_student)
plot(nu_student_pred)</code></pre>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-30-1.png" width="960" /></p>
<p>The way to read this plot is to start at the top left and work your way down to the ‚Äúprediction‚Äù row. The intercept represents the overall average. That is, if I knew nothing about a college, this is my best guess. Stepping down one row, we see that Northwestern is ranked 28th of all colleges, which contributes to ~$10K increase in mid career pay. However, the cost of living in Illinois appears to be lower than the rest of the country, which depresses expected earnings by ~$8K. From there, you can ‚Äúwalk‚Äù by each factor to get to the final prediction of $120K. This is how a breakdown plot works - it helps us understand which variables explain the most variation and how they contribute relative to one another.</p>
<p>We can even create a fictitious college, such as the the one below.</p>
<pre class="r"><code>state_u_student &lt;- tibble(college_name = &#39;State U&#39;,
                      college_rank = 400,
                      cost_of_living = mean(x_values %&gt;% pull(cost_of_living)),
                      pct_stem = 25,
                      for_sports_fans = 1,
                      private_school = 0,
                      religious = 0,
                      research_university = 1,
                      state_school = 1
)
state_u_student_pred &lt;- DALEX::predict_parts_break_down(explainer_xg, state_u_student)
plot(state_u_student_pred)</code></pre>
<p><img src="/post/2021-04-11-college-rankings-salary/college_rankings_salary_files/figure-html/unnamed-chunk-31-1.png" width="960" /></p>
<p>The plot above is interpreted exactly the same - if we attended ‚ÄúState U,‚Äù our expected annual mid-career pay would be somewhere around $98K.</p>
</div>
<div id="conclusion-does-rank-matter" class="section level3">
<h3>Conclusion: Does Rank Matter?</h3>
<p>It‚Äôs important to note that our outcome variable ‚Äì median mid-career pay ‚Äì is a summary statistic. Thus, we do not know how much information each college contributed to our estimates, as the raw data (i.e., the individual responses associated with each college) are not available. However, these findings feel correct. Even after considering the caveat mentioned above, it is apparent that where you attend college is strongly associated (but not necessarily cause) with shifts in how much you earn later in life. This is especially true for top-ranked colleges. The difference between attending a college ranked in the top-10 relative to the top-100 has substantial pay implications, while this difference is less critical among lower-ranked colleges.</p>
<p>Hopefully, you enjoyed the post. I‚Äôd love to hear your feedback, so feel free to comment below!</p>
</div>
<div id="appendix" class="section level3">
<h3>Appendix</h3>
<pre class="python"><code># college_cost_of_living_data.py
import urllib
from bs4 import BeautifulSoup
import re
import pandas as pd
from datetime import datetime
from typing import List
import logging

start_time = datetime.now().strftime(&quot;%Y-%m-%d %H-%M-%S&quot;)
logging.basicConfig(
    filename=f&quot;college-rankings-pay-{start_time}.log&quot;,
    format=&quot;%(levelname)s - %(asctime)s - %(filename)s - %(message)s&quot;,
    level=logging.DEBUG,
)
logger = logging.getLogger(__name__)


def scrape_col_data() -&gt; List[str]:
    base_url = &quot;https://meric.mo.gov/data/cost-living-data-series&quot;
    page = urllib.request.urlopen(base_url).read()
    soup = BeautifulSoup(page)
    col_data = soup.findAll(&quot;tbody&quot;)[0].findAll(&quot;tr&quot;)
    col_data_lst = str(col_data).split(&quot;&lt;/tr&gt;&quot;)
    return col_data_lst


def format_col_data(col_data_lst: List[str]) -&gt; pd.DataFrame:
    field_names = [&quot;state&quot;, &quot;cost_of_living&quot;]
    regex_state = re.compile(&quot;&gt;[0-9]{1,2}&lt;/td&gt;\n&lt;td&gt;(.+?)\xa0&lt;&quot;)
    regex_col_index = re.compile(&quot;\xa0&lt;/td&gt;\n&lt;td&gt;([0-9]{2,3}.\d)&lt;/td&gt;&quot;)
    all_states_col = list()
    for state in col_data_lst:
        try:
            state_name = re.search(regex_state, state).group(1)
            state_col = re.search(regex_col_index, state).group(1)
            row = [state_name, state_col]
            all_states_col.append(row)
        except Exception as e:
            logger.error(
                f&quot;Problem extract table from wikipedia for {state}&quot;, exc_info=True
            )
    all_states_df = pd.DataFrame(all_states_col, columns=field_names)
    return all_states_df


def collect_col_data() -&gt; pd.DataFrame():
    col_data_lst = scrape_col_data()
    col_df = format_col_data(col_data_lst=col_data_lst)
    return col_df</code></pre>
<pre class="python"><code># collect_payscale_data.py
import urllib
from bs4 import BeautifulSoup
import re
import pandas as pd
from typing import List
import time
from tqdm import tqdm

N_PAGES = 20

def scrape_pay_data(page_number: int) -&gt; List:
    base_url = f&quot;https://www.payscale.com/college-salary-report/bachelors/page/{str(page_number)}&quot;
    page = urllib.request.urlopen(base_url).read()
    soup = BeautifulSoup(page)
    college_data = soup.findAll(&quot;tbody&quot;)[0].findAll(&quot;tr&quot;)
    college_data = [str(x) for x in college_data]
    return college_data


def format_pay_data(college_data: str) -&gt; pd.DataFrame:
    field_names = [&quot;name&quot;, &quot;rank&quot;, &quot;type&quot;, &quot;pct_stem&quot;, &quot;early_pay&quot;, &quot;mid_pay&quot;]
    regex_name = re.compile(&#39;&lt;a href=&quot;/research/US/School=(.+?)/Salary&#39;)
    regex_rank = re.compile(
        &#39;&quot;&gt;Rank&lt;!-- --&gt;:&lt;/span&gt;&lt;span class=&quot;data-table__value&quot;&gt;(.+?)&lt;/span&gt;&#39;
    )
    regex_type = re.compile(
        &#39;&gt;School Type&lt;!-- --&gt;:&lt;/span&gt;&lt;span class=&quot;data-table__value&quot;&gt;(.+?)&lt;/span&gt;&#39;
    )
    regex_early_pay = re.compile(
        &#39;&gt;Early Career Pay&lt;!-- --&gt;:&lt;/span&gt;&lt;span class=&quot;data-table__value&quot;&gt;(.+?)&lt;/span&gt;&#39;
    )
    regex_mid_pay = re.compile(
        &#39;&gt;Mid-Career Pay&lt;!-- --&gt;:&lt;/span&gt;&lt;span class=&quot;data-table__value&quot;&gt;(.+?)&lt;/span&gt;&#39;
    )
    regex_pct_stem = re.compile(
        &#39;&gt;% STEM Degrees&lt;!-- --&gt;:&lt;/span&gt;&lt;span class=&quot;data-table__value&quot;&gt;(.+?)&lt;/span&gt;&#39;
    )
    all_college_data = list()
    # TO DO - ADD LOGGING
    for college in college_data:
        try:
            name = re.search(regex_name, college).group(1)
            rank = re.search(regex_rank, college).group(1)
            type_ = re.search(regex_type, college).group(1)
            early_pay = re.search(regex_early_pay, college).group(1)
            mid_pay = re.search(regex_mid_pay, college).group(1)
            pct_stem = re.search(regex_pct_stem, college).group(1)
            row = [name, rank, type_, pct_stem, early_pay, mid_pay]
            all_college_data.append(row)
        except Exception as e:
            print(e)
    college_df = pd.DataFrame(all_college_data, columns=FIELD_NAMES)
    return college_df


def collect_payscale_college_salary_data() -&gt; pd.DataFrame:
    all_colleges_df = pd.DataFrame(columns=FIELD_NAMES)
    for page_number in tqdm(range(1, (N_PAGES + 1))):
        college_data = scrape_pay_data(page_number=page_number)
        college_data_df = format_pay_data(college_data=college_data)
        all_colleges_df = all_colleges_df.append(college_data_df)
        time.sleep(2)
    return all_colleges_df</code></pre>
<pre class="r"><code># Helper function for visualization
my_plot_theme = function(){
  font_family = &quot;Helvetica&quot;
  font_face = &quot;bold&quot;
  return(theme(
    axis.text.x = element_text(size = 16, face = font_face, family = font_family),
    axis.text.y = element_text(size = 16, face = font_face, family = font_family),
    axis.title.x = element_text(size = 16, face = font_face, family = font_family),
    axis.title.y = element_text(size = 16, face = font_face, family = font_family),
    strip.text.y = element_text(size = 22, face = font_face, family = font_family),
    plot.title = element_text(size = 22, face = font_face, family = font_family),
    
    legend.position = &quot;top&quot;,
    legend.title = element_text(size = 16,
                                face = font_face,
                                family = font_family),
    legend.text = element_text(size = 16,
                               face = font_face,
                               family = font_family),
    legend.key = element_rect(size = 5),
    legend.key.size = unit(1.5, &#39;lines&#39;)
  ))
}</code></pre>
</div>
