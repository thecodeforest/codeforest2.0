---
title: "The Optimal Portland Pub Crawl"
author: "Mark LeBoeuf"
date: '2018-06-01T21:13:14-05:00'
summary: Portland, Oregon is home to some of the best watering holes in America. With
  so many places to quaff a West Coast Style IPA or glass of Pinot Noir, choosing
  which to visit (and in which order) can be a daunting task. To address this question,
  we'll leverage some classic optimization techniques to minimize the total distance
  travelled between the top bars in Portland for a truly "optimal" Pub Crawl.
tags:
- R
- Python
- Reticulate
- Traveling Salesman Problem
- Route Optimization
categories:
- R
- Python
- Reticulate
- Traveling Salesman Problem
- Route Optimization
---

<script src="/rmarkdown-libs/htmlwidgets/htmlwidgets.js"></script>
<script src="/rmarkdown-libs/pymjs/pym.v1.js"></script>
<script src="/rmarkdown-libs/widgetframe-binding/widgetframe.js"></script>


<p><img src="/post/2018-06-01-optimal-bar-crawl/images/portland.jpg" width="700" height="600" /></p>
<div id="overview" class="section level3">
<h3>Overview</h3>
<p>The premise of a Pub Crawl is quite simple: visit several bars in an afternoon or evening without a clear plan of where you‚Äôll go next. While this sort of spontaneous, unstructured approach may work for some people, I‚Äôve always been a fan of having a plan ‚Äì in this case, an optimal plan. If we want to maximize the number of places visited (and beers tasted) in a finite period of time, then there is simply no room for shoddy planning. Accordingly, this post provides a framework for designing the optimal Portland Pub Crawl by working through the following steps:</p>
<p>üç∫ Web Scrape the top 100 Portland bars from <a href="http://www.oregonlive.com/dining/index.ssf/2014/10/portlands_100_best_bars_bar_ta.html">here</a></p>
<p>üç∫ Geocode each bar‚Äôs location</p>
<p>üç∫ Find the optimal route between a subsample of the bars, because visiting 100 in a day would make the following day very bad</p>
<p>üç∫ Determine a walking path between the bars</p>
<p>üç∫ Create a map of the walking path, which can be use as a field guide to impress your friends once the pub crawl is under way</p>
<p>üç∫ Promptly spill beer on the map at the 2nd bar, rendering it unreadable, followed by a game of darts and some popcorn</p>
<p>If that sounds like a plan, let‚Äôs get started!</p>
</div>
<div id="defining-the-top-100-bars" class="section level3">
<h3>Defining the Top 100 Bars</h3>
<p>First, let‚Äôs identify the stops during our tour of Portland‚Äôs pub scene. In the section below, we‚Äôll load up the R libraries, identify which version of Python we‚Äôd like to use, and then do some web scraping. Note that all of the python modules and R-scripts are contained in the same directory for simplicity.</p>
<pre class="r"><code># Core pacakges
library(tidyverse)

# Mapping
library(leaflet)
library(widgetframe)
library(leaflet.extras)

# Calling python functions from R
library(reticulate)

# route optimization
library(tspmeta)

# Making nice tables
library(gt)</code></pre>
<p>The <code>geocode_best_portland_bars</code> function below is responsible for collecting the information.</p>
<pre class="python"><code># best_bars.py

import os
import urllib
from bs4 import BeautifulSoup
import re
from typing import List
import googlemaps
from tqdm import tqdm
import pandas as pd
from dotenv import load_dotenv

API_KEY = os.getenv(&#39;GOOGLE_API_KEY&#39;)


def find_best_bars() -&gt; str:
    base_url = &quot;http://www.oregonlive.com/dining/index.ssf/2014/10/portlands_100_best_bars_bar_ta.html&quot;
    page = urllib.request.urlopen(base_url)
    soup = BeautifulSoup(page, &quot;html.parser&quot;)
    bar_descriptors = soup.find_all(&quot;div&quot;, class_=&quot;entry-content&quot;)
    bar_descriptors = str(bar_descriptors).split(&quot;&lt;p&gt;&quot;)[0]
    best_bars_raw_lst = re.findall(r&quot;\&lt;strong&gt;(.*?)&lt;/strong&gt;&quot;, bar_descriptors)
    return best_bars_raw_lst


def clean_bar_names(raw_bar_lst: str) -&gt; List[str]:
    # exclude emphasis tags
    best_bars = [re.sub(r&quot;&lt;em&gt; (.*?)&lt;/em&gt;&quot;, &quot;&quot;, x) for x in raw_bar_lst]
    # exclude number included in bar name
    best_bars = [re.sub(r&quot;No. \d+ --&quot;, &quot;&quot;, x).strip() for x in best_bars]
    # exclude headers in all caps
    best_bars = [x for x in best_bars if not x.isupper()]
    # exclude all lower case tags
    best_bars = [x for x in best_bars if not x.islower()]
    # exclude bold tags in html
    best_bars = [x.replace(&quot;&amp;amp;&quot;, &quot;&amp;&quot;) for x in best_bars]
    # exclude other emphasis tags
    best_bars = [re.sub(r&quot;: &lt;em&gt;(.*?)&lt;/em&gt;&quot;, &quot;&quot;, x) for x in best_bars]
    # strip colons
    best_bars = [x.replace(&quot;:&quot;, &quot;&quot;) for x in best_bars]
    # exclude blanks
    best_bars = [x for x in best_bars if x]
    return best_bars


def geocode_best_portland_bars() -&gt; pd.DataFrame:
    best_bars_lst = find_best_bars()
    bar_names = clean_bar_names(raw_bar_lst=best_bars_lst)
    bar_names = [f&quot;{x}, Portland, OR&quot; for x in bar_names]
    gmaps = googlemaps.Client(key=API_KEY)
    geocoded_bars_lst = []
    for name in tqdm(bar_names):
        geocode_result = gmaps.geocode(name)
        lat_lng = geocode_result[0].get(&quot;geometry&quot;).get(&quot;location&quot;)
        lat, lng = lat_lng.get(&quot;lat&quot;), lat_lng.get(&quot;lng&quot;)
        geocoded_bars_lst.append([name, lat, lng])
    geocoded_bars_df = pd.DataFrame(geocoded_bars_lst)
    geocoded_bars_df.columns = [&quot;name&quot;, &quot;lat&quot;, &quot;lng&quot;]
    return geocoded_bars_df   </code></pre>
<p>Historically, this operation would require executing a python script, writing the results out (in an <code>.txt</code> or <code>.csv</code> file), and then reading the result back into R. However, with the advent of <code>reticulate</code>, we can execute a python function and pull the output back without ever having to leave the cozy confines of R (or R-studio in this case). Recall that the actual python module <code>geocode_best_portland_bars.py</code> is located in the same directory as our R-script. Below, we‚Äôll first ‚Äúsource‚Äù this function via <code>source_python</code> (which simply means to bring it into the R environment), then we‚Äôll execute it. Note that we aren‚Äôt passing in any arguments; this function is designed for a very specific purpose, which is to find the best watering holes in Portland.</p>
<pre class="r"><code># specify which version of Python to use
reticulate::use_python(&#39;//anaconda/bin/python&#39;, required = TRUE)

# brings our function into the R Environment
reticulate::source_python(&#39;best_bars.py&#39;)

# executes and stores the output  in our variable &#39;best_bars&#39;
best_bars = geocode_best_portland_bars()</code></pre>
<pre class="r"><code>best_bars %&gt;%
  tail(10) %&gt;%
  mutate(name = str_replace(name, &#39;, Portland, OR&#39;, &#39;&#39;)) %&gt;%
  gt() %&gt;%
  tab_header(title = gt::md(&#39;**Data Sample of Best Portland Bars**&#39;)) %&gt;%
  cols_align(
  align = &quot;center&quot;,
  columns = everything()) %&gt;%
  cols_width(
    everything() ~ px(155)
    )</code></pre>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#zupfrgawbr .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#zupfrgawbr .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zupfrgawbr .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#zupfrgawbr .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#zupfrgawbr .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zupfrgawbr .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#zupfrgawbr .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#zupfrgawbr .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#zupfrgawbr .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#zupfrgawbr .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#zupfrgawbr .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#zupfrgawbr .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#zupfrgawbr .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#zupfrgawbr .gt_from_md > :first-child {
  margin-top: 0;
}

#zupfrgawbr .gt_from_md > :last-child {
  margin-bottom: 0;
}

#zupfrgawbr .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#zupfrgawbr .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#zupfrgawbr .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zupfrgawbr .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#zupfrgawbr .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#zupfrgawbr .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#zupfrgawbr .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#zupfrgawbr .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#zupfrgawbr .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zupfrgawbr .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#zupfrgawbr .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#zupfrgawbr .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#zupfrgawbr .gt_left {
  text-align: left;
}

#zupfrgawbr .gt_center {
  text-align: center;
}

#zupfrgawbr .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#zupfrgawbr .gt_font_normal {
  font-weight: normal;
}

#zupfrgawbr .gt_font_bold {
  font-weight: bold;
}

#zupfrgawbr .gt_font_italic {
  font-style: italic;
}

#zupfrgawbr .gt_super {
  font-size: 65%;
}

#zupfrgawbr .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="zupfrgawbr" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:155px;"/>
    <col style="width:155px;"/>
    <col style="width:155px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="3" class="gt_heading gt_title gt_font_normal" style><strong>Data Sample of Best Portland Bars</strong></th>
    </tr>
    <tr>
      <th colspan="3" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">name</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">lat</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">lng</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">Swine</td>
      <td class="gt_row gt_center">45.51827</td>
      <td class="gt_row gt_center">-122.6818</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Jackknife</td>
      <td class="gt_row gt_center">45.52051</td>
      <td class="gt_row gt_center">-122.6828</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Stammtisch</td>
      <td class="gt_row gt_center">45.52586</td>
      <td class="gt_row gt_center">-122.6375</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Cooper's Hall</td>
      <td class="gt_row gt_center">45.51988</td>
      <td class="gt_row gt_center">-122.6596</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">The Knock Back</td>
      <td class="gt_row gt_center">45.55923</td>
      <td class="gt_row gt_center">-122.6416</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Multnomah Whiskey Library</td>
      <td class="gt_row gt_center">45.52098</td>
      <td class="gt_row gt_center">-122.6835</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Trifecta Tavern &amp; Bakery</td>
      <td class="gt_row gt_center">45.51756</td>
      <td class="gt_row gt_center">-122.6596</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Angel Face</td>
      <td class="gt_row gt_center">45.52321</td>
      <td class="gt_row gt_center">-122.6371</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Pepe Le Moko</td>
      <td class="gt_row gt_center">45.52187</td>
      <td class="gt_row gt_center">-122.6813</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Expatriate</td>
      <td class="gt_row gt_center">45.56240</td>
      <td class="gt_row gt_center">-122.6346</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>We have successfully scraped the best bars and geocoded their locations. In the following section, we‚Äôll solve a classic routing optimization problem: The Traveling Salesman Problem (TSP). The goal is to find the most direct route between all of the bars we decide to visit during the pub crawl.</p>
</div>
<div id="route-optimization" class="section level3">
<h3>Route Optimization</h3>
<p>The goal of any routing optimization problem is simple: minimize the total distance travelled between different nodes (locations) in space while ensuring that each node is visited once. There are many algorithms to solve this type of problem, but we‚Äôll leverage the <code>2-optimization</code> or <code>2-opt</code> method due to its simplicity. This algorithm finds the lowest cost route (i.e., the route with the shortest distance that ensures each node is visited once) by swapping the ‚Äòedges‚Äô (the path that connects two nodes) between different nodes. If a swap reduces the total length of our tour, then the swap is maintained; otherwise the swap is reversed and we try again with different edges. Note that the swap must ensure that a single route is always possible between all nodes. The algorithm stops when a tour is reached that cannot be improved with any more swaps (see <a href="https://ocw.mit.edu/courses/sloan-school-of-management/15-053-optimization-methods-in-management-science-spring-2013/lecture-notes/MIT15_053S13_lec17.pdf">here</a> for a more in-depth explanation).</p>
<p>Before going any further, let‚Äôs plot out our locations to see what we‚Äôre working with. We‚Äôll also define our starting point, which is often referred to as the ‚Äòdepot‚Äô.</p>
<pre class="r"><code>depot_lat = 45.525915
depot_lng = -122.684957

bar_map = leaflet(data = best_bars) %&gt;% 
          setView(lng = depot_lng + 0.05, lat = depot_lat, zoom = 13) %&gt;% 
          addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
          addMarkers(lng=depot_lng, lat=depot_lat) %&gt;% 
          addCircleMarkers(lat=~lat, 
                           lng=~lng,
                           color = &quot;orange&quot;,
                           radius = 4,
                           weight = 10,
                           stroke = FALSE,
                           opacity = 4,
                           fillOpacity = 4
                           ) </code></pre>
<div id="htmlwidget-1" style="width:100%;height:400px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-1">{"x":{"url":"/post/2018-06-01-optimal-bar-crawl/optimal_bar_crawl_files/figure-html//widgets/widget_unnamed-chunk-7.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>Each orange dot is a bar, and the pointer indicates our starting position (the depot). Given that we are walking, let‚Äôs limit the potential distance to a maximum of three miles from our starting location. The function below calculates the total feet between two points defined by a latitude/longitude coordinate.</p>
<pre class="r"><code>earth_dist = function (lat1, lng1, lat2, lng2)
{
  rad = pi/180
  a1 = lat1 * rad
  a2 = lng1 * rad
  b1 = lat2 * rad
  b2 = lng2 * rad
  dlon = b2 - a2
  dlat = b1 - a1
  a = (sin(dlat/2))^2 + cos(a1) * cos(b1) * (sin(dlon/2))^2
  c = 2 * atan2(sqrt(a), sqrt(1 - a))
  R = 6378.145
  d = R * c
  return(d* 3280.8)
}</code></pre>
<p>Below we‚Äôll filter to all locations based on the maximum distance we‚Äôre willing to travel.</p>
<pre class="r"><code>feet_in_mile = 5280
# maximum distance is 3 miles
max_miles_away = 3

bar_locations_nearby = best_bars %&gt;% 
                       mutate(distance_from_depot = earth_dist(depot_lat,
                                                               depot_lng,
                                                               lat,
                                                               lng
                                                               )
                              ) %&gt;% 
                       filter(distance_from_depot &lt;= feet_in_mile * max_miles_away)</code></pre>
<pre class="r"><code>set.seed(1)

# we&#39;ll visit 24 bars
n_bars = 24

# randomly select 24 bars to visit
bar_locations_nearby = bar_locations_nearby %&gt;% 
                       sample_n(n_bars)</code></pre>
<p>Next we‚Äôll transform the lat/long locations into a distance matrix. The distance matrix specifies the euclidean distance of each bar from every other bar.</p>
<pre class="r"><code># now find optimal route
coordinates = bar_locations_nearby %&gt;% 
              dplyr::select(lat, lng, name) %&gt;% 
              mutate(location_index = 2:(n() + 1)) %&gt;% 
              bind_rows(data.frame(lat = depot_lat,
                                   lng = depot_lng,
                                   address = &#39;depot&#39;,
                                   name = &#39;depot&#39;,
                                   location_index = 1
                                          )
                               ) %&gt;% 
              arrange(location_index)

coords_matrix = coordinates %&gt;% 
                dplyr::select(lat, lng) %&gt;% 
                as.matrix()

dist_matrix = dist(coords_matrix)</code></pre>
<p>The two functions below <code>tsp_instance</code> and <code>run_solver</code> will do the heavy lifting and find the optimal route between bars.</p>
<pre class="r"><code># create tsp instance
tsp_ins = tspmeta::tsp_instance(coords_matrix,dist_matrix)

# find optimal route based on 2-opt method
opt_tour = as.integer(run_solver(tsp_ins, method=&quot;2-opt&quot;))

# sort to start at depot
sorted_tour = c(opt_tour[which(opt_tour == 1):length(opt_tour)],
                opt_tour[1:(which(opt_tour == 1) - 1)]
                )

# join route order back to original data
coordinates = coordinates %&gt;% 
              dplyr::inner_join(data.frame(location_index = sorted_tour,
                                           route_order = 1:length(sorted_tour)
                                           )
                                ) %&gt;% 
              dplyr::arrange(route_order)

# reformat so each row has a starting lat/lng and ending lat/lng
route_df = coordinates %&gt;% 
            dplyr::select(-address) %&gt;%
            dplyr::rename(start_lat = lat,
                          start_lng = lng
                          ) %&gt;% 
            dplyr::mutate(end_lat = c(start_lat[2:n()], NA),
                          end_lng = c(start_lng[2:n()], NA)
                          ) %&gt;% 
            na.omit()</code></pre>
<p>Let‚Äôs take a peak at our data to see how everything turned out.</p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#dmhypywntg .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 16px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#dmhypywntg .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dmhypywntg .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#dmhypywntg .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#dmhypywntg .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dmhypywntg .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#dmhypywntg .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#dmhypywntg .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#dmhypywntg .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#dmhypywntg .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#dmhypywntg .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#dmhypywntg .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#dmhypywntg .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#dmhypywntg .gt_from_md > :first-child {
  margin-top: 0;
}

#dmhypywntg .gt_from_md > :last-child {
  margin-bottom: 0;
}

#dmhypywntg .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#dmhypywntg .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#dmhypywntg .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dmhypywntg .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#dmhypywntg .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#dmhypywntg .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#dmhypywntg .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#dmhypywntg .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#dmhypywntg .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dmhypywntg .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#dmhypywntg .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#dmhypywntg .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#dmhypywntg .gt_left {
  text-align: left;
}

#dmhypywntg .gt_center {
  text-align: center;
}

#dmhypywntg .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#dmhypywntg .gt_font_normal {
  font-weight: normal;
}

#dmhypywntg .gt_font_bold {
  font-weight: bold;
}

#dmhypywntg .gt_font_italic {
  font-style: italic;
}

#dmhypywntg .gt_super {
  font-size: 65%;
}

#dmhypywntg .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="dmhypywntg" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:115px;"/>
    <col style="width:115px;"/>
    <col style="width:115px;"/>
    <col style="width:115px;"/>
    <col style="width:115px;"/>
    <col style="width:115px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="6" class="gt_heading gt_title gt_font_normal" style><strong>Route</strong></th>
    </tr>
    <tr>
      <th colspan="6" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">name</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">route_order</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">start_lat</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">start_lng</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">end_lat</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">end_lng</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">depot</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">45.52591</td>
      <td class="gt_row gt_center">-122.6850</td>
      <td class="gt_row gt_center">45.52627</td>
      <td class="gt_row gt_center">-122.6784</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Park Kitchen</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">45.52627</td>
      <td class="gt_row gt_center">-122.6784</td>
      <td class="gt_row gt_center">45.52531</td>
      <td class="gt_row gt_center">-122.6783</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Remedy Wine Bar</td>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_center">45.52531</td>
      <td class="gt_row gt_center">-122.6783</td>
      <td class="gt_row gt_center">45.52201</td>
      <td class="gt_row gt_center">-122.6816</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Clyde Common</td>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_center">45.52201</td>
      <td class="gt_row gt_center">-122.6816</td>
      <td class="gt_row gt_center">45.52246</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Cassidy's</td>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_center">45.52246</td>
      <td class="gt_row gt_center">-122.6852</td>
      <td class="gt_row gt_center">45.52098</td>
      <td class="gt_row gt_center">-122.6835</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Multnomah Whiskey Library</td>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_center">45.52098</td>
      <td class="gt_row gt_center">-122.6835</td>
      <td class="gt_row gt_center">45.51487</td>
      <td class="gt_row gt_center">-122.6824</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">The Rookery at Raven &amp; Rose</td>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_center">45.51487</td>
      <td class="gt_row gt_center">-122.6824</td>
      <td class="gt_row gt_center">45.51400</td>
      <td class="gt_row gt_center">-122.6753</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Veritable Quandary</td>
      <td class="gt_row gt_center">8</td>
      <td class="gt_row gt_center">45.51400</td>
      <td class="gt_row gt_center">-122.6753</td>
      <td class="gt_row gt_center">45.51904</td>
      <td class="gt_row gt_center">-122.6781</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Departure</td>
      <td class="gt_row gt_center">9</td>
      <td class="gt_row gt_center">45.51904</td>
      <td class="gt_row gt_center">-122.6781</td>
      <td class="gt_row gt_center">45.52403</td>
      <td class="gt_row gt_center">-122.6756</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">Ground Kontrol</td>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_center">45.52403</td>
      <td class="gt_row gt_center">-122.6756</td>
      <td class="gt_row gt_center">45.51900</td>
      <td class="gt_row gt_center">-122.6641</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Sweet! Almost there. The final step is to convert these points into an actual travel path.</p>
</div>
<div id="creating-a-walking-path" class="section level3">
<h3>Creating a Walking Path</h3>
<p>Currently, the path between different nodes (i.e., bars) are straight lines. We‚Äôll be walking this tour, so a sidewalk travel path is required. We‚Äôll call on the Google Maps API one last time to convert each of the straight-line edges to actual walking paths via the <code>convert_route_to_path.py</code> module. This module consists of two functions: <code>find_path</code> and <code>extract_polyline</code>. <code>find_path</code> takes a starting lat/long, ending lat/long, and method of travel (walking in our case) and returns step-by-step lat/long coordinates along with distance and time estimates. <code>extract_polyline</code> is a helper function that will format each of the step-by-step coordinates into pandas DataFrame. The output will then be returned as an R DataFrame. We‚Äôll specify the python module below.</p>
<pre class="python"><code># convert_route_to_path.py
import os
import pandas as pd
import polyline
import googlemaps
from dotenv import load_dotenv

load_dotenv()

API_KEY = os.getenv(&#39;GOOGLE_API_KEY&#39;)

def extract_polyline(coords: dict) -&gt; pd.DataFrame:
    gmaps_polyline = coords[&quot;overview_polyline&quot;][&quot;points&quot;]
    polyline_df = pd.DataFrame(polyline.decode(gmaps_polyline))
    polyline_df.columns = [&quot;lat&quot;, &quot;lng&quot;]
    polyline_df[&quot;path_order&quot;] = range(1, polyline_df.shape[0] + 1)
    return polyline_df


def create_travel_path(
    route_df: pd.DataFrame, travel_mode: str = &quot;walking&quot;
) -&gt; pd.DataFrame:
    gmaps = googlemaps.Client(key=API_KEY)
    out_route_df = pd.DataFrame()
    for row in route_df.itertuples():
        coords = gmaps.directions(
            origin=[row.start_lat, row.start_lng],
            destination=[row.end_lat, row.end_lng],
            mode=travel_mode,
        )
        coords_df = extract_polyline(coords=coords[0])
        coords_df[&quot;location_index&quot;] = row.location_index
        coords_df[&quot;travel_time&quot;] = coords[0][&quot;legs&quot;][0][&quot;duration&quot;][&quot;value&quot;]
        coords_df[&quot;miles&quot;] = coords[0][&quot;legs&quot;][0][&quot;distance&quot;][&quot;text&quot;]
        coords_df[&quot;route_order&quot;] = row.route_order
        out_route_df = out_route_df.append(coords_df)
    out_route_df = out_route_df.reset_index(drop=True)
    return out_route_df</code></pre>
<p>Next, we‚Äôll read the <code>convert_route_to_path.py</code> module into R and pass in our route DataFrame, the Google Maps API key, and our preferred method of travel.</p>
<pre class="r"><code>reticulate::source_python(&#39;convert_route_to_path.py&#39;)
path_df = create_travel_path(route_df)</code></pre>
<p>The data indicating the path between our depot and the first bar should look like this:</p>
<style>html {
  font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, 'Helvetica Neue', 'Fira Sans', 'Droid Sans', Arial, sans-serif;
}

#pamufqigws .gt_table {
  display: table;
  border-collapse: collapse;
  margin-left: auto;
  margin-right: auto;
  color: #333333;
  font-size: 10px;
  font-weight: normal;
  font-style: normal;
  background-color: #FFFFFF;
  width: auto;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #A8A8A8;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #A8A8A8;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
}

#pamufqigws .gt_heading {
  background-color: #FFFFFF;
  text-align: center;
  border-bottom-color: #FFFFFF;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pamufqigws .gt_title {
  color: #333333;
  font-size: 125%;
  font-weight: initial;
  padding-top: 4px;
  padding-bottom: 4px;
  border-bottom-color: #FFFFFF;
  border-bottom-width: 0;
}

#pamufqigws .gt_subtitle {
  color: #333333;
  font-size: 85%;
  font-weight: initial;
  padding-top: 0;
  padding-bottom: 4px;
  border-top-color: #FFFFFF;
  border-top-width: 0;
}

#pamufqigws .gt_bottom_border {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pamufqigws .gt_col_headings {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
}

#pamufqigws .gt_col_heading {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  padding-left: 5px;
  padding-right: 5px;
  overflow-x: hidden;
}

#pamufqigws .gt_column_spanner_outer {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: normal;
  text-transform: inherit;
  padding-top: 0;
  padding-bottom: 0;
  padding-left: 4px;
  padding-right: 4px;
}

#pamufqigws .gt_column_spanner_outer:first-child {
  padding-left: 0;
}

#pamufqigws .gt_column_spanner_outer:last-child {
  padding-right: 0;
}

#pamufqigws .gt_column_spanner {
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: bottom;
  padding-top: 5px;
  padding-bottom: 6px;
  overflow-x: hidden;
  display: inline-block;
  width: 100%;
}

#pamufqigws .gt_group_heading {
  padding: 8px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
}

#pamufqigws .gt_empty_group_heading {
  padding: 0.5px;
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  vertical-align: middle;
}

#pamufqigws .gt_from_md > :first-child {
  margin-top: 0;
}

#pamufqigws .gt_from_md > :last-child {
  margin-bottom: 0;
}

#pamufqigws .gt_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  margin: 10px;
  border-top-style: solid;
  border-top-width: 1px;
  border-top-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 1px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 1px;
  border-right-color: #D3D3D3;
  vertical-align: middle;
  overflow-x: hidden;
}

#pamufqigws .gt_stub {
  color: #333333;
  background-color: #FFFFFF;
  font-size: 100%;
  font-weight: initial;
  text-transform: inherit;
  border-right-style: solid;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
  padding-left: 12px;
}

#pamufqigws .gt_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pamufqigws .gt_first_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
}

#pamufqigws .gt_grand_summary_row {
  color: #333333;
  background-color: #FFFFFF;
  text-transform: inherit;
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
}

#pamufqigws .gt_first_grand_summary_row {
  padding-top: 8px;
  padding-bottom: 8px;
  padding-left: 5px;
  padding-right: 5px;
  border-top-style: double;
  border-top-width: 6px;
  border-top-color: #D3D3D3;
}

#pamufqigws .gt_striped {
  background-color: rgba(128, 128, 128, 0.05);
}

#pamufqigws .gt_table_body {
  border-top-style: solid;
  border-top-width: 2px;
  border-top-color: #D3D3D3;
  border-bottom-style: solid;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
}

#pamufqigws .gt_footnotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pamufqigws .gt_footnote {
  margin: 0px;
  font-size: 90%;
  padding: 4px;
}

#pamufqigws .gt_sourcenotes {
  color: #333333;
  background-color: #FFFFFF;
  border-bottom-style: none;
  border-bottom-width: 2px;
  border-bottom-color: #D3D3D3;
  border-left-style: none;
  border-left-width: 2px;
  border-left-color: #D3D3D3;
  border-right-style: none;
  border-right-width: 2px;
  border-right-color: #D3D3D3;
}

#pamufqigws .gt_sourcenote {
  font-size: 90%;
  padding: 4px;
}

#pamufqigws .gt_left {
  text-align: left;
}

#pamufqigws .gt_center {
  text-align: center;
}

#pamufqigws .gt_right {
  text-align: right;
  font-variant-numeric: tabular-nums;
}

#pamufqigws .gt_font_normal {
  font-weight: normal;
}

#pamufqigws .gt_font_bold {
  font-weight: bold;
}

#pamufqigws .gt_font_italic {
  font-style: italic;
}

#pamufqigws .gt_super {
  font-size: 65%;
}

#pamufqigws .gt_footnote_marks {
  font-style: italic;
  font-size: 65%;
}
</style>
<div id="pamufqigws" style="overflow-x:auto;overflow-y:auto;width:auto;height:auto;"><table class="gt_table" style="table-layout: fixed;; width: 0px">
  <colgroup>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
    <col style="width:100px;"/>
  </colgroup>
  <thead class="gt_header">
    <tr>
      <th colspan="7" class="gt_heading gt_title gt_font_normal" style><strong>Sample Travel Path</strong></th>
    </tr>
    <tr>
      <th colspan="7" class="gt_heading gt_subtitle gt_font_normal gt_bottom_border" style></th>
    </tr>
  </thead>
  <thead class="gt_col_headings">
    <tr>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">location_index</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">route_order</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">travel_time</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">miles</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">path_order</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">lat</th>
      <th class="gt_col_heading gt_columns_bottom_border gt_center" rowspan="1" colspan="1">lng</th>
    </tr>
  </thead>
  <tbody class="gt_table_body">
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">45.52576</td>
      <td class="gt_row gt_center">-122.6849</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">2</td>
      <td class="gt_row gt_center">45.52575</td>
      <td class="gt_row gt_center">-122.6853</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">3</td>
      <td class="gt_row gt_center">45.52508</td>
      <td class="gt_row gt_center">-122.6853</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">4</td>
      <td class="gt_row gt_center">45.52449</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">5</td>
      <td class="gt_row gt_center">45.52443</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">6</td>
      <td class="gt_row gt_center">45.52362</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">7</td>
      <td class="gt_row gt_center">45.52312</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">8</td>
      <td class="gt_row gt_center">45.52304</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">9</td>
      <td class="gt_row gt_center">45.52282</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">10</td>
      <td class="gt_row gt_center">45.52263</td>
      <td class="gt_row gt_center">-122.6853</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">11</td>
      <td class="gt_row gt_center">45.52247</td>
      <td class="gt_row gt_center">-122.6854</td>
    </tr>
    <tr>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">1</td>
      <td class="gt_row gt_center">344</td>
      <td class="gt_row gt_center">0.3 mi</td>
      <td class="gt_row gt_center">12</td>
      <td class="gt_row gt_center">45.52243</td>
      <td class="gt_row gt_center">-122.6852</td>
    </tr>
  </tbody>
  
  
</table></div>
<p>Note the small changes between each of the successive lat/long coordinates. This is the path we‚Äôll be walking to obtain our first frosty mug of beer. Before mapping our data, let‚Äôs get a general idea of total walking time and distance.</p>
<pre class="r"><code>travel_time_in_hours = round(path_df %&gt;% 
                             dplyr::select(location_index, travel_time) %&gt;% 
                             dplyr::distinct() %&gt;% 
                             dplyr::pull(travel_time) %&gt;% 
                             sum() / 3600, 1)

print(glue::glue(&quot;Total Travel Time Is: &quot;,
                 travel_time_in_hours,
                 &quot; Hours&quot;
                 )
      )</code></pre>
<pre><code>## Total Travel Time Is: 6.6 Hours</code></pre>
<p>It looks like this walk will take around six hours, so we‚Äôll need to bring some comfy shoes. What about distance (we‚Äôll need some way to work off those calories)?</p>
<pre class="r"><code>travel_distance_in_miles = round(path_df %&gt;% 
  dplyr::mutate(feet_numeric = 
                case_when(stringr::str_detect(miles, &#39;ft&#39;) == TRUE ~ 
                          as.numeric(stringr::str_replace(miles, 
                                                          &quot; ft&quot;, 
                                                          &quot;&quot;
                                                          )
                                     ),
                          stringr::str_detect(miles, &quot; mi&quot;) == TRUE ~ 
                          as.numeric(stringr::str_replace(miles, 
                                                          &quot; mi&quot;, 
                                                          &quot;&quot;)
                                     ) * feet_in_mile
                         )
                ) %&gt;% 
  dplyr::select(location_index, feet_numeric) %&gt;% 
  dplyr::distinct() %&gt;% 
  dplyr::pull(feet_numeric) %&gt;% 
  sum() / feet_in_mile, 1)

print(glue::glue(&quot;Total Travel Distance Is: &quot;,
                 travel_distance_in_miles,
                 &quot; Miles&quot;
                 )
      )</code></pre>
<pre><code>## Total Travel Distance Is: 19 Miles</code></pre>
<p>OK, this is more of a Pub Crawl half-marathon. That‚Äôs some serious distance to cover. Let‚Äôs bring it all together with some visualization.</p>
</div>
<div id="mapping-the-route" class="section level3">
<h3>Mapping the Route</h3>
<p>The last step is to bring this analysis to life with everyone‚Äôs favorite visualization: MAPS! Indeed, we‚Äôll plot the walking path across downtown Portland so we can actually see the Pub Crawl route.</p>
<pre class="r"><code># We&#39;ll use this to identify the labels for each stop 
label_df = path_df %&gt;% 
           dplyr::filter(path_order == 1)

# Bar crawl visualization
final_route = leaflet(data = path_df) %&gt;%
  setView(lng = depot_lng + 0.04, lat = depot_lat + 0.01, zoom = 13) %&gt;% 
  addProviderTiles(&quot;CartoDB.Positron&quot;) %&gt;%
  addPolylines(data = path_df %&gt;% 
                 filter(route_order &lt; 24),
               lng = ~lng,
               lat = ~lat,
               color = &quot;orange&quot;,
               opacity = 4
  ) %&gt;% 
  addMarkers(lng = depot_lng,
             lat = depot_lat
  ) %&gt;% 
  addCircleMarkers(data = label_df,
                   lng = ~lng,
                   lat = ~lat,
                   radius = 4,
                   label = ~as.character(route_order),
                   labelOptions = labelOptions(noHide = T,
                                               textOnly = T,
                                               direction = &#39;top&#39;,
                                               textsize = &quot;14px&quot;,
                                               offset=c(0,-5),
                                               size = 1
                   )
  )</code></pre>
<div id="htmlwidget-2" style="width:100%;height:600px;" class="widgetframe html-widget"></div>
<script type="application/json" data-for="htmlwidget-2">{"x":{"url":"/post/2018-06-01-optimal-bar-crawl/optimal_bar_crawl_files/figure-html//widgets/widget_unnamed-chunk-21.html","options":{"xdomain":"*","allowfullscreen":false,"lazyload":false}},"evals":[],"jsHooks":[]}</script>
<p>Whew! That was a lot of work but it looks like we have a reasonable solution. We‚Äôll start in downtown Portland, take a quick jaunt over to the Eastside of the city and eventually return back to the Northwest. So, there you have it ‚Äì a real-world application of optimization that supports an efficient Pub Crawl. Prost!</p>
</div>
